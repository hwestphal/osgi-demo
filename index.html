<!DOCTYPE html>
<html>
	<head>
		<title>Introduction to OSGi</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

		<link rel="stylesheet" href="css/style.css" type="text/css">
		<link rel="stylesheet" href="http://alexgorbatchev.com/pub/sh/current/styles/shThemeDefault.css" type="text/css">
	</head>

	<body ng-app="PresentationModule" ng-controller="PresentationController">
		<div id="all">
	
			<div id="intro">
				<h1>Introduction to OSGi</h1>
				<h2>Harald Westphal</h2>
				<h3 ng-show="isAfter()">http://github.com/hwestphal/osgi-demo</h3>
			</div>
	
			<p id="counter" ng-show="isInsideDeck()">
				<a href="#/slides/1">&laquo;</a>
				{{activeSlide + 1}} / {{totalSlides}}
				<a href="#/slides/{{totalSlides}}">&raquo;</a>
			</p>
	
			<deck current="activeSlide" total="totalSlides">
				<slide>
					<h2>Topics</h2>
					<ul>
						<li>Basics
						<li>Module system
						<li>Services
						<li>Server-side OSGi
						<li>Implementations, tools and testing
						<li>Live demo
					</ul>
				</slide>

				<slide>
					<h2>History</h2>
					<ul>
						<li><strong><i>O</i></strong>pen <strong><i>S</i></strong>ervices <strong><i>G</i></strong>ateway <strong><i>i</i></strong>nitiative
						<li>First release (R1) May 2000
						<li>Latest release (R5) June 2012
						<li>~2003: Eclipse selected OSGi as core runtime (RCP)
						<li>~2007: First server-side adoptions
					</ul>
				</slide>

				<slide>
					<h2>Features</h2>
					<p>
						<img src="images/osgi_features.png">
					</p>
				</slide>
				
				<slide>
					<h2>Architecture</h2>
					<p>
						<img src="images/osgi_architecture.png">
					</p>
				</slide>

				<slide>
					<h2>Module System</h2>
					<ul>
						<li>Basic blocks: Bundles (mostly JARs)
						<li>Have a lifecycle
						<li>Export packages (with a distinct version)
						<li>Import packages (of a given version range)
						<li>OSGi runtime resolves dependencies
						<li>Framework is a bundle itself (sytem bundle)
					</ul>
				</slide>
				
				<slide>
					<h2>Bundle Lifecycle</h2>
					<p>
						<img src="images/osgi_bundle_lifecycle.png">
					</p>
				</slide>

				<slide>
					<h2>Bundle Class Loading</h2>
					<ul>
						<li>Network instead of parent delegation
					</ul>
					<p>
						<img src="images/osgi_classloading.png">
					</p>
				</slide>

				<slide>
					<h2>Bundle Manifest</h2>
					<ul>
						<li>Additions to META-INF/MANIFEST.MF
						<li>Contains bundle meta-data
					</ul>
					<script type="syntaxhighlighter" slide-code="plain">
						Bundle-ManifestVersion: 2
						Bundle-Name: A dummy bundle
						Bundle-SymbolicName: org.test.bundle.foo.bar
						Bundle-Version: 2.0.2.QUALIFIER
						Export-Package: org.test.bundle.foo.bar.api;version="1.1.0", org.test.bundle.foo.bar.tools
						Import-Package: org.apache.log4j.api;version="[1.2,2)"
					</script>
				</slide>

				<slide>
					<h2>Bundle Classpath</h2>
					<ul>
						<li>Default classpath is <code>.</code>
						<li>Can be customized (e.g. for embedded JARs)
					</ul>
					<script type="syntaxhighlighter" slide-code="plain">
						Bundle-ClassPath: .,commons-codec-1.6.jar
					</script>
				</slide>

				<slide>
					<h2>Bundle Entries vs. Resources</h2>
					<ul>
						<li>Goal: access non-class files that are part of the bundle
						<li>OSGi makes a distinction between resources and entries
						<li>Used for images, HTML pages, ...
					</ul>
					<script type="syntaxhighlighter" slide-code="java">
						BundleContext context = ...;
						// lookup in bundle's classpath
						URL resource = context.getBundle().getResource("...");
						// lookup in bundle's directory
						URL entry = context.getBundle().getEntry("...");
					</script>
				</slide>

				<slide>
					<h2>Bundle Fragments</h2>
					<ul>
						<li>Add-ons to existing bundles
						<li>Don't have a lifecycle on their own
						<li>Extend the host bundle's content and meta-data
						<li>Typical usecases: test fragments, localized resources, native libraries
					</ul>
					<script type="syntaxhighlighter" slide-code="plain">
						Bundle-SymbolicName: org.eclipse.ui.win32
						Fragment-Host: org.eclipse.ui.ide;bundle-version="[3.2.0,4.0.0)"
						Eclipse-PlatformFilter: (osgi.ws=win32)
					</script>
				</slide>

				<slide>
					<h2>Bundle Activator</h2>
					<ul>
						<li>Piece of code which is executed on bundle activation and deactivation time
						<li>Access to the bundle context and the whole framework runtime dynamics
					</ul>
					<script type="syntaxhighlighter" slide-code="java">
						// Bundle-Activator: org.test.bundle.foo.internal.Activator
						public class Activator implements BundleActivator {
							public void start(BundleContext context) throws Exception {
								...
							}							

							public void stop(BundleContext context) throws Exception {
								...
							}							
						}
					</script>					
				</slide>

				<slide>
					<h2>What is a service?</h2>
					<ul>
						<li>A Java object which is published in the Service Registry
						<li>It is published with one or more names (typically the FQN of an interface)
						<li>Can be registered and unregistered by a bundle at any time
						<li>Service references can be obtained by other bundles using the service's name
					</ul>
				</slide>

				<slide>
					<h2>Service Registration</h2>
					<ul>
						<li>Can contain meta-data information (defined by the framework and custom)
					</ul>
					<script type="syntaxhighlighter" slide-code="java">
						IHelloWorldService service = new HelloWorldService();
						Dictionary<String, Object> props = new Hashtable<String, Object>();
						props.put(Constants.SERVICE_RANKING, 10);
						props.put(Constants.SERVICE_VENDOR, "test.org");
						props.put("foobar", true);
						ServiceRegistration<IHelloWorldService> registration = context.registerService(IHelloWorldService.class, service, props);
						registration.unregister();
					</script>					
				</slide>

				<slide>
					<h2>Service Consumption</h2>
					<ul>
						<li>Two-step process: Get service reference(s), get service object from reference 
					</ul>
					<script type="syntaxhighlighter" slide-code="java">
						ServiceReference<IHelloWorldService> reference = context.getServiceReference(IHelloWorldService.class);
						IHelloWorldService service = context.getService(reference);
						service.hello("Joe");
						context.ungetService(reference);
					</script>					
					<ul>
						<li>Obtained references can be filtered
					</ul>
					<script type="syntaxhighlighter" slide-code="java">
						Collection<ServiceReference<IHelloWorldService>> refs = context.getServiceReferences(IHelloWorldService.class, "(&(service.vendor=test.org)(foobar=true))");
					</script>					
				</slide>
				
				<slide>
					<h2>We just scraped the surface...</h2>
					<ul>
						<li>org.osgi.framework.ServiceFactory: Creates services lazily
						<li>org.osgi.util.tracker.ServiceTracker: Deals with service dynamics
						<li>Declarative Services: Provide and consume service declaratively, dependency injection
						<li>A bunch of standard and framework services...
					</ul>
				</slide>
				
				<slide>
					<h2>OSGi on the server side</h2>
					<ul>
						<li>OSGi's module system and the dynamic service concept is interesting for server and/or enterprise applications
						<li>But beware: Dealing with a dynamic runtime environment is hard
						<li>OSGi: SOA for the JVM
						<li>See <a href="http://www.theserverside.com/news/thread.tss?thread_id=62590">"Rod Johnson on OSGi"</a>
					</ul>
				</slide>
				
				<slide>
					<h2>Web Applications</h2>
					<ul>
						<li>Variant 1: Using the OSGi HTTP Service (and its extensions)
						<li>Variant 2: Embedding an OSGi runtime in a web application ("Servlet Bridge")
						<li>Variant 3: Framework extensions that treat WARs as bundles
					</ul>
				</slide>

				<slide>
					<h2>HTTP Service</h2>
					<ul>
						<li>Rather limited features
						<li>Implementors provide extended interfaces to allow all features from the Servlet specification
					</ul>
					<script type="syntaxhighlighter" slide-code="java">
						HttpService httpService = ...;
						HttpContext httpContext = httpService.createDefaultHttpContext();
						httpService.registerResources("/", "/static_files", httpContext);
						httpService.registerServlet("/rest", new MyRestServlet(), httpContext);
						httpService.unregister("/rest");
						httpService.unregister("/rest");
					</script>					
				</slide>
				
				<slide>
					<h2>Implementations</h2>
					<ul>
						<li>Equinox
						<li>Apache Felix
						<li>Knopflerfish
					</ul>
				</slide>

				<slide>
					<h2>Equinox</h2>
					<ul>
						<li>Reference implementation
						<li>Core runtime for Eclipse RCP
						<li>Great tooling in Eclipse IDE
						<li>Not so great tooling for automated builds
						<li>Many extensions to the core specification
					</ul>
				</slide>
				
				<slide>
					<h2>Equinox/Eclipse Terminology</h2>
					<ul>
						<li>Plugin: Bundle + Extension (Points) 
						<li>Feature: Grouping of plugins
						<li>Product: Grouping of features, branding and configuration
						<li>Update Site: Place where plugins and features can be downloaded
						<li>Target Platform: Set of plugins and features where dependencies are resolved
					</ul>
				</slide>

				<slide>
					<h2>Apache Felix</h2>
					<ul>
						<li>"Lightweight" approach
						<li>More appropriate for embedding in standard Java applications
						<li>Great tooling for Maven and Ant based builds
					</ul>
				</slide>

				<slide>
					<h2>Maven and OSGi</h2>
					<ul>
						<li>All the bundles, where do they all come from?
						<li>Maven defines a dependency model on its own
						<li>Does <strong>NOT</strong> match the OSGi model
						<li>Variant 1: Code/POM first (BND, maven-bundle-plugin)
						<li>Variant 2: Manifest first (tycho)
					</ul>
				</slide>

				<slide>
					<h2>Testing: Best Practices</h2>
					<ul>
						<li>Minimize dependencies on OSGi
						<li>Run unit tests without OSGi
						<li>Classloading issues are often detected only during runtime
						<li>Write integration tests / smoke tests for checking dependency resolution and service registration/consumption
						<li>When using Maven, use <a href="http://team.ops4j.org/wiki/display/paxexam/Pax+Exam">Pax Exam</a> for that
					</ul>
				</slide>

				<slide class="interlude">
					<h2></h2>
					<h3>Okay, it's demo time!</h3>
					<img src="images/boing.gif">
				</slide>
			</deck>

		</div>
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.1/angular.min.js"></script>
		<script src="js/presentation.js"></script>

		<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shCore.js"></script>
		<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shBrushJava.js"></script>
		<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shBrushXml.js"></script>
		<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shBrushPlain.js"></script>
		<script>
			SyntaxHighlighter.all();
		</script>		
	</body>
</html>
